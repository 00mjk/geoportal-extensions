<!DOCTYPE html>
<html>
    <head>
        <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

        <!-- Library OpenLayers 3 -->
        <link rel="stylesheet" href="../../../lib/ol3/ol.css" />
        <script src="../../../lib/ol3/ol-debug.js"></script>

        <!-- Plugin OpenLayers 3 IGN -->
        <link rel="stylesheet" href="../../../dist/ol3/GpPluginOl3.css" />
        <script src="../../../dist/ol3/GpPluginOl3-src.js" data-url="./../resources/AutoConf.js"></script>

        <!-- load geoportail-waiting image -->
        <style>
            div#map {
                background-image:url(../resources/geoportail-waiting.gif);
                background-position:center center;
                background-repeat:no-repeat;
            }
        </style>
    </head>
    <body>
        <h1>
            <a href="http://openlayers.org/"><img src="../resources/logo-ol3.png" alt="OpenLayers3" width="100" /></a>
            <a href="http://www.ign.fr"><img src="../resources/logo-ign.jpg" alt="IGN" width="100" /></a>
        </h1>
        <h3>
            OpenLayers3 - A high-performance, feature-packed library for all your mapping needs.
        </h3>
        <div>
            <!-- Faire une bréve description du plugin -->
            <p>Ajout du widget GetFeatureInfo.</p>
            <p>Cet exemple permet de tester le widget de manière générale. La carte est initialisée avec des couches de différentes natures interrogeables via des actions différentes.<p>
            <p>Pour certaines couches l'action déclenchant la requête GFI est définie explicitement à l'initialisation, pour d'autres c'est l'évènement par défaut qui déclenchera la requête.<p>
            <p>Parmi les tests réalisables on a :<p>
            <ul>
              <li>Le changement du style du curseur au survol d'objets vecteurs</li>
              <li>La modification de l'évènement par défaut déclenchant la requête GFI (valable seulement pour les couches dont l'évènement associé n'aura pas été défini à l'initialisation)</li>
              <li>L'activation/désactivation du widget. Vérifier lors de la désactivation qu'aucune requête n'est envoyée, que le curseur n'apparaît plus, que l'on a bien le menu contextuel au click droit, que le double click permet de zoomer...</li>
              <li>Pour les couches associées au même évènement, jouer, grâce à l'outil de gestion des couches, sur l'ordre d'empilement et vérifier que c'est bien la couche la plus haute qui répond prioritairement</li>
              <li>Pour les couches vecteurs ayant le même évènement associé, vérifier que si l'on click sur un pixel où sont situés les objets de plusieurs couches la fenêtre popup GFI affiche les propriétés de tous ces objets en respectant l'ordre d'empilement</li>
              <li>Vérifier que la suppression de toutes les couches requétables entraîne la désactivation des évènements, la disparition du curseur, le retour du zoom au double click, l'apparition du menu contextuel au click droit</li>
            </ul>

            <!-- map -->
            <div id="map" style="height: 500px; width: 800px;"></div>
            <button type="button" id="testRemoveLayer">Supprimer une couche</button>
            <button type="button" id="changeCursorStyle">Changer le style du cursor</button>
            <button type="button" id="changeDefaultEvent">Changer l'événement par défaut</button>
            <button type="button" id="changeActive">Activer/désactiver</button>

            <!-- Mettre le code source de l'exemple -->
            <script>
                var map;
                window.onload = function () {
                    document.getElementById('map').style.backgroundImage = 'none';

                    // 1. Création de la map
                    map = new ol.Map({
                        target : "map",
                        view : new ol.View({
                            center : [288074.8449901076, 6247982.515792289],
                            zoom : 6
                        })
                    });

                    // 2. Ajout de plusieurs couches différentes.
                    var gpMaps = new ol.layer.Tile({
                        source : new ol.source.GeoportalWMTS({
                            layer: "GEOGRAPHICALGRIDSYSTEMS.MAPS"
                        })
                    });
                    map.addLayer(gpMaps);

                    var gpMyKml = new ol.layer.Vector({
                        source: new ol.source.Vector({
                            url: './../resources/KML/S_TOP100.kml',
                            format: new ol.format.KML()
                        })
                    });
                    map.addLayer(gpMyKml);

                    var gpRoad = new ol.layer.Tile({
                        source : new ol.source.GeoportalWMS({
                            layer: "TN.RoadTransportNetwork"
                        })
                    });
                    map.addLayer(gpRoad);

                    var gpHydro = new ol.layer.Tile({
                        source : new ol.source.GeoportalWMS({
                            layer: "HY.PhysicalWaters"
                        })
                    });
                    map.addLayer(gpHydro);

                    // 3. Ajout du GetFeatureInfo
                    var getFeatureInfo = new ol.control.GetFeatureInfo({
                            layers : [
                                {
                                    obj : gpHydro,
                                    infoFormat : "text/html",
                                    event: "contextmenu"
                                },
                                {
                                    obj : gpMyKml,
                                    infoFormat : "text/html",
                                    event: "dblclick"
                                },
                                {
                                    obj : gpRoad,
                                }
                            ],
                            options : {
                                active: true,
                                defaultInfoFormat: "text/html",
                                defaultEvent: "singleclick",
                                cursorStyle: "pointer",
                                // noProxyDomains: [],
                                // proxyUrl: ""
                            }
                        });
                    map.addControl(getFeatureInfo);

                    // 4. Quelques évènements pour tester...
                    document.getElementById("testRemoveLayer").onclick = function(e) {
                        if ( map.getLayers() && map.getLayers().getLength() > 0 )
                        {
                            map.removeLayer(map.getLayers().item(0));
                        }
                    }

                    document.getElementById("changeCursorStyle").onclick = function(e) {
                        if ( !this.styles )
                        {
                          this.styles = ["cell","crosshair","none","pointer","progress"];
                        }
                        if ( !this.index )
                        {
                            this.index = 0;
                        }

                        ++this.index;
                        if ( this.index ==  this.styles.length ) {
                            this.index = 0;
                        }
                        getFeatureInfo.setCursorStyle(this.styles[this.index]);
                    }
                    document.getElementById("changeDefaultEvent").onclick = function(e) {
                        if ( !this.events )
                        {
                          this.events = ["singleclick","dblclick","contextmenu"];
                        }
                        if ( !this.index )
                        {
                            this.index = 0;
                        }
                        ++this.index;
                        if ( this.index ==  this.events.length ) {
                            this.index = 0;
                        }
                        getFeatureInfo.setDefaultEvent(this.events[this.index]);
                    }
                    document.getElementById("changeActive").onclick = function(e) {
                        if ( !this.active )
                        {
                          this.active = false;
                        }
                        getFeatureInfo.setActive(this.active);
                        this.active = !this.active;
                    }

                }
            </script>
        </div>
    </body>
</html>
