<!DOCTYPE html>
<html>
    <head>
        <meta content="IE=edge,chrome=1; charset=UTF-8" http-equiv="X-UA-Compatible">
        <title>sample ol3 GetFeatureInfo</title>

        <!-- Library OpenLayers 3 -->
        <link rel="stylesheet" href="../../../lib/ol3/ol.css" />
        <!-- <script src="../../../lib/ol3/ol-debug.js"></script> -->

        <!-- Plugin OpenLayers 3 IGN -->
        <link rel="stylesheet" href="../../../dist/ol3/GpPluginOl3.css" />
        <!-- <script src="../../../dist/ol3/GpPluginOl3.js" data-url="./../resources/AutoConf.js"></script> -->

        <!-- requirejs -->
        <script src="../../../lib/require.js"></script>

        <!-- load geoportail-waiting image -->
        <style>
            div#map {
                background-image:url(../resources/geoportail-waiting.gif);
                background-position:center center;
                background-repeat:no-repeat;
                max-width: 800px;
                height: 300px;
                margin: 10px;
            }
        </style>
    </head>
    <body>
        <h1>
            <a href="http://openlayers.org/"><img src="../resources/logo-ol3.png" alt="OpenLayers3" width="100" /></a>
            <a href="http://www.ign.fr"><img src="../resources/logo-ign.jpg" alt="IGN" width="100" /></a>
        </h1>
        <h3>
            OpenLayers3 - A high-performance, feature-packed library for all your mapping needs.
        </h3>

        <div>
            <p>Ajout du widget GetFeatureInfo.</p>
            <p>Cet exemple permet de tester le widget de manière générale. La carte est initialisée avec des couches de différentes natures interrogeables via des actions différentes.<p>
            <p>Pour certaines couches l'action déclenchant la requête GFI est définie explicitement à l'initialisation, pour d'autres c'est l'évènement par défaut qui déclenchera la requête.<p>
            <p>Parmi les tests réalisables on a :<p>
            <ul>
              <li>Le changement du style du curseur au survol d'objets vecteurs</li>
              <li>La modification de l'évenement par défaut déclenchant la requête GFI (valable seulement pour les couches dont l'évènement associé n'aura pas été défini à l'initialisation)</li>
              <li>L'activation/désactivation du widget. Vérifier lors de la désactivation qu'aucune requête n'est envoyée, que le curseur n'apparaît plus, que l'on a bien le menu contextuel au click droit, que le double click permet de zoomer...</li>
              <li>Pour les couches associées au même évènement, jouer, grâce à l'outil de gestion des couches, sur l'ordre d'empilement et vérifier que c'est bien la couche la plus haute qui répond prioritairement</li>
              <li>Pour les couches vecteurs ayant le même évènement associé, vérifier que si l'on click sur un pixel où sont situés les objets de plusieurs couches la fenêtre popup GFI affiche les propriétés de tous ces objets en respectant l'ordre d'empilement</li>
              <li>Vérifier que la suppression de toutes les couches requétables entraine la désactivation des évenements, la disparition du curseur, le retour du zoom au double click, l'apparition du menu contextuel au click droit</li>
            <!-- map -->
            <div id="map" style="height: 500px; width: 800px;"></div>
            <button type="button" id="testRemoveLayer">Supprimer une couche</button>
            <button type="button" id="changeCursorStyle">Changer le style du cursor</button>
            <button type="button" id="changeDefaultEvent">Changer l'événement par défaut</button>
            <button type="button" id="changeActive">Activer/désactiver</button>
            <button type="button" id="addVectorKml">Ajouter une couche vecteur kml</button>

            <script>
                var map;
                /* global requirejs */
                requirejs.config({
                    "baseUrl" : "../../../src/",
                    "paths": {
                        // lib external
                        "ol" : "../lib/ol3/ol-debug",
                        "proj4"   : "../lib/proj4/proj4-src",
                        "gp"      : "../lib/gp/GpServices-src",
                        "sortable" : "../lib/sortable/Sortable",
                        "woodman" : "../lib/woodman/woodman-amd"
                    }
                });
                requirejs(
                    ["ol", "proj4", "gp", "Ol3/Layers/LayerWMS" , "Ol3/Layers/LayerWMTS", "Ol3/Controls/GetFeatureInfo", "Ol3/Controls/LayerSwitcher"],
                    function (ol, proj4, Gp, LayerWMS, LayerWMTS, GetFeatureInfo, LayerSwitcher)
                {
                    var createMap = function() {
                        // on cache l'image de chargement du Géoportail.
                        document.getElementById('map').style.backgroundImage = 'none';

                        // 1. Création de la map
                        map = new ol.Map({
                            target : "map",
                            view : new ol.View({
                                center : [288074.8449901076, 6247982.515792289],
                                zoom : 6
                            })
                        });

                        // 2. Ajout de plusieurs couches différentes.
                        var gpMaps = new LayerWMTS({
                            layer: "GEOGRAPHICALGRIDSYSTEMS.MAPS",
                        });
                        map.addLayer(gpMaps);

                        var gpMyKml = new ol.layer.Vector({
                            source: new ol.source.Vector({
                                url: './../resources/KML/S_TOP100.kml',
                                format: new ol.format.KML()
                            })
                        });
                        map.addLayer(gpMyKml);

                        var gpRoad = new LayerWMS({
                          layer : "TN.RoadTransportNetwork",
                        });
                        map.addLayer(gpRoad);

                        var gpHydro = new LayerWMS({
                          layer : "HY.PhysicalWaters",
                        });
                        map.addLayer(gpHydro);

                        // 3. Ajout du GetFeatureInfo
                        var getFeatureInfo = new GetFeatureInfo({
                            layers : [
                                {
                                    obj : gpHydro,
                                    infoFormat : "text/html",
                                    event: "contextmenu"
                                },
                                {
                                    obj : gpMyKml,
                                    infoFormat : "text/html",
                                    event: "dblclick"
                                },
                                {
                                    obj : gpRoad,
                                },
                                {
                                    obj : gpMaps //pour test : non interrogeable
                                }
                            ],
                            options : {
                                active: true,
                                defaultInfoFormat: "text/html",
                                defaultEvent: "singleclick",
                                cursorStyle: "pointer",
                                // noProxyDomains: [],
                                // proxyUrl: ""
                            }
                        });
                        map.addControl(getFeatureInfo);

                        // 4. Ajout du contrôle de gestion de l'empilement des couches (layerSwitcher)
                        var layerSwitcher = new LayerSwitcher({
                            options : {
                                collapsed: false
                            }
                        });
                        map.addControl(layerSwitcher);

                        // 5. Quelques évènements pour tester...
                        document.getElementById("testRemoveLayer").onclick = function(e) {
                            if ( map.getLayers() && map.getLayers().getLength() > 0 )
                            {
                                map.removeLayer(map.getLayers().item(0));
                            }
                        }
                        document.getElementById("changeCursorStyle").onclick = function(e) {
                            if ( !this.styles )
                            {
                              // la chaine vide doit desactiver l'evenement
                              this.styles = ["cell","crosshair","none","pointer","progress",""];
                            }
                            if ( !this.index )
                            {
                                this.index = 0;
                            }

                            ++this.index;
                            if ( this.index ==  this.styles.length ) {
                                this.index = 0;
                            }
                            getFeatureInfo.setCursorStyle(this.styles[this.index]);
                        }
                        document.getElementById("changeDefaultEvent").onclick = function(e) {
                            if ( !this.events )
                            {
                              this.events = ["singleclick","dblclick","contextmenu"];
                            }
                            if ( !this.index )
                            {
                                this.index = 0;
                            }
                            ++this.index;
                            if ( this.index ==  this.events.length ) {
                                this.index = 0;
                            }
                            getFeatureInfo.setDefaultEvent(this.events[this.index]);
                        }
                        document.getElementById("changeActive").onclick = function(e) {
                            if ( !this.active )
                            {
                              this.active = false;
                            }
                            getFeatureInfo.setActive(this.active);
                            this.active = !this.active;
                        }
                        document.getElementById("addVectorKml").onclick = function(e) {
                            if ( !this.kmlUrls )
                            {
                              this.kmlUrls = [
                                './../resources/KML/S_TOP100.kml',
                                './../resources/KML/bassin_bleu.kml',
                                './../resources/KML/croquis-simple.kml'
                              ];
                            }
                            if ( !this.index )
                            {
                                this.index = 0;
                            }
                            ++this.index;
                            if ( this.index ==  this.kmlUrls.length ) {
                                this.index = 0;
                            }
                            map.addLayer(
                                new ol.layer.Vector({
                                    source: new ol.source.Vector({
                                        url: this.kmlUrls[this.index],
                                        format: new ol.format.KML()
                                    })
                                })
                            );
                        }
                    }

                    Gp.Services.getConfig({
                        serverUrl : "./../resources/AutoConf.js",
                        callbackSuffix : '',
                        // apiKey: "jhyvi0fgmnuxvfv0zjzorvdn",
                        timeOut : 20000,
                        onSuccess : createMap
                    });

                });
            </script>
            </div>
        </div>
    </body>
</html>
